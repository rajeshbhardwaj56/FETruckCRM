
@{
    ViewBag.Title = "Customer LISTING";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var success = TempData["Success"];
    var Err = TempData["Error"];
}

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="p_title">Customer LISTING</div>
            <div class="buttons-wrap">
                <div class="left__buttons">
                    @Html.ActionLink("Add Customer", "AddCustomer", new { id = 0 }, new { @class = "btn btn-primary bg-orange" })
                    <a href="@Url.Action("ExportToExcelCustomer", "Customer")">

                        <img src="~/assets/images/xlsx.ico" width="40px" title="Export To Excel" />
                    </a>
                </div>

            </div>
        </div>
    </div>
</div>
<div class="page-content-bg slds-scrollable">
    <!-- DATA TABLE-->
    <section class="">
        <div class="container">
            <div class="row">
                <div class="col-md-12">

                    <div class="table-responsive table-responsive-data2">
                        <table class="table table-data2" id="tblCustomer">
                            <thead>
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Address</th>
                                    <th>City</th>
                                    <th>State</th>
                                    <th>Zip</th>
                                    <th>Telephone</th>
                                    <th>Status</th>
                                    <th>Approval Status</th>
                                    <th>Date Added</th>
                                    <th>Added By User</th>
                                    <th>Team Lead</th>
                                    <th>Team Manager</th>
                                    <th>Total Credit Limit</th>
                                    <th>Total Credit Limit Used</th>
                                    <th>Remaining Credit Limit</th>
                                    <th>On Hold</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>

                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- END DATA TABLE-->


</div>
<script src="@Url.Content("~/assets/js/datatables.js")"></script>
<script type="text/javascript">
        $(document).ready(function () {
            $('#tblCustomer').DataTable({

                "bServerSide": true,
                "sAjaxSource": "loadCustomerdata",
                "sServerMethod": "POST",
                "scrollX": true,
                "aoColumns": [
                    { "data": "CustomerName", "autoWidth": true },
                    { "data": "Address", "autoWidth": true },
                    { "data": "City", "autoWidth": true },
                    { "data": "StateName", "autoWidth": true },
                    { "data": "Zip", "autoWidth": true },
                    { "data": "Telephone", "autoWidth": true },
                    { "data": "strStatus", "autoWidth": true },
                    { "data": "strApprovalStatus", "autoWidth": true },
                    { "data": "strCreatedDate", "autoWidth": true },
                    //{
                    //    "data": "CreatedDate", "autoWidth": true,
                    //    "render": function (data) {
                    //        //debugger;
                    //        var pattern = /Date\(([^)]+)\)/;
                    //        var results = pattern.exec(data);
                    //        var date = new Date(parseFloat(results[1]))
                    //        var month = date.getMonth() + 1;
                    //        return (month.toString().length > 1 ? month : "0" + month) + "/" + date.getDate()   + "/" + date.getFullYear();
                    //    }
                    //},
                    { "data": "AddedByUser", "autoWidth": true },
                    { "data": "TeamLead", "autoWidth": true },
                    { "data": "TeamManager", "autoWidth": true },
                    {
                        "data": "CreditLimit", "autoWidth": true, 'render': function (CreditLimit) {
                            return '$' + CreditLimit;
                        }},
                    {
                        "data": "TotalCreditLimitUsed", "autoWidth": true, 'render': function (TotalCreditLimitUsed) {return '$' + TotalCreditLimitUsed;}  },
                    { "data": "RemainingCreditLimit", "autoWidth": true, 'render': function (RemainingCreditLimit) { return '$' + RemainingCreditLimit; }  },
    {
                        // this is Actions Column
                        mRender: function (data, type, row) {
                            debugger;
                            var lt = row.CustomerID;
            var isdel = row.IsOnHold;

                            var linkEdit1 = '<div class="table-data-feature"><input type="checkbox" onchange="IsOnHold(this,' + lt + ');"/></div>';
            if (isdel == true) {
                linkEdit1 = '<div class="table-data-feature"><input type="checkbox" checked onchange="IsOnHold(this,' + lt + ');"/></div>';
            }

                           // var dt = "<input type='text' class='datepicker' />"
                            return linkEdit1 ;
                        }
                    },
                    {
                        // this is Actions Column
                        mRender: function (data, type, row) {
                            debugger;
                          //  var linkEdit = '@Html.ActionLink("Edit", "AddCustomer", new {id= -1 })';
                            var linkNoti = '<div class="table-data-feature"><a data-toggle="tooltip" data-placement="top"  class="item"  href="@Url.Action("Customernotifications", "Customer", new { customerID= -1 })" title="Add Email Notification"  data-original-title="Edit"><img src="/assets/images/emailnoti.png" /></a>';
                            linkNoti = linkNoti.replace("-1", row.CustomerID);
                            var linkEdit = '<div class="table-data-feature"><a data-toggle="tooltip" data-placement="top"  class="item"  href="@Url.Action("AddCustomer", "Customer", new { id = -1 })" title="Edit"  data-original-title="Edit"><i class="fa fa-pencil" aria-hidden="true"></i></a>';
                            linkEdit = linkEdit.replace("-1", row.CustomerID);
                            var linkDelete = '<a data-toggle="tooltip" data-placement="top" class="item" style="margin-left:5px;"  onclick="DeleteFunction(' + row["CustomerID"] + ')" title="Delete"  data-original-title="Delete"><i class="fa fa-trash" aria-hidden="true"></i></a></div>';
                            return linkNoti + " " +linkEdit + " " + linkDelete;
                            }
                    }

                     // for edit icon = < i class= "mdi mdi-border-color" ></i >
                    // for delete icon =  <i class="mdi mdi-delete"></i>
                ],
                "columnDefs": [
                    {
                        "targets": [16], //first and last not sortable
                        "orderable": false,
                        "defaultContent": " "
                    },
                     {
                        "targets": [15], //first and last not sortable
                        "orderable": false,
                        "defaultContent": " ",
                        "visible": '@ViewBag.RoleName' == "SuperAdmin"
                        //"visible": function (data, type, row) {
                        //    return row.Role == "Accounting" ? true : false;
                        //}
                    }
                ]
                , "responsive": true

            });


        });

    var err = '@Err';
        var success = '@success';
    if (err != null && err != '') {

        ShowError(err);
    }
    if (success != null && success != '') {

        ShowSucess(success);
    }
        function ShowSucess(msg) {
            $.notifyBar({ cssClass: "success", html: msg });
        }
        function ShowError(msg) {
            $.notifyBar({ cssClass: "error", html: msg });
        }
       function IsOnHold(e, CustomerID) {
        debugger;

           var data = { "CustomerID": CustomerID, "IsOnHold": e.checked ? 1 : 0 };
            $.ajax({
                type: 'POST',
                url: 'OnHold',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(data),
                dataType: 'json',
                success: function (s) {
                    //debugger;
                    if (s.data > 0) {
                        $('#tblCustomer').DataTable().ajax.reload();
                        $("#divLoader").hide();
                        ShowSucess(s.msg);
                    }
                    else {
                        if (s.timeout == true) {
                            $("#divLoader").hide();

                            window.location.href = "/Account/Login";
                        }
                        else {
                            ShowError(s.msg); $("#divLoader").hide();
                        }
                    }

                },
                error: function (s) {
                    if (s.timeout == true) {

                        window.location.href = "/Account/Login";
                    } }
            });
    }
    function DeleteFunction(CustomerID) {
        debugger;
        if (confirm('Are you sure you want to delete this customer?')) {
            $("#divLoader").show();
            var data = { "CustomerID": CustomerID };
            $.ajax({
                type: 'POST',
                url: 'Delete',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(data),
                dataType: 'json',
                success: function (s) {
                    //debugger;
                    if (s.data > 0) {
                        $('#tblCustomer').DataTable().ajax.reload();
                        $("#divLoader").hide();
                        ShowSucess(s.msg);
                    }
                    else {
                        if (s.timeout == true) {
                            $("#divLoader").hide();

                            window.location.href = "/Account/Login";
                        }
                        else {
                            ShowError(s.msg); $("#divLoader").hide();
                        }
                    }

                },
                error: function (s) {
                    if (s.timeout == true) {

                        window.location.href = "/Account/Login";
                    } }
            });

            return true;
        }
        else {
            return false;
        }
    }
</script>

<script>
    var oTable = $('#tbl').dataTable({
        "bServerSide": true,
        "sAjaxSource": "/Patient/GetPatientList",
        "sServerMethod": "POST",
        "aoColumns": [
            { "mData": "PatientName" },
            { "mData": "EmailId" },
            { "mData": "MobileNumber" },
            { "mData": "Location" },
            { "mData": "CityName" },
            { "mData": "StateName" },
            {
                "mData": function (o) {
                    return "<a href='/Patient/Edit?Id=" + o.Id + "' class='btn btn-info'><i class='fa fa-pencil'></i></a>";
                }
            }
        ],
    });
</script>
